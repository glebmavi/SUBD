# Выполнение

## Этап 1. Резервное копирование

### Включение режима архивирования WAL на основном узле

Изменяем конфигурационный файл [`postgresql.conf`](./main_pg167/postgresql.conf) на основном узле, отправляя WAL-логи на резервный узел:
```conf
wal_level = replica
archive_mode = on
archive_command = 'scp %p postgres0@pg175:~/wal_archive/%f'
```

В резервном узле создаем директорию для хранения WAL:
```bash
mkdir -p wal_archive # учитываем, что директория будет создана в домашнем каталоге пользователя
```

На основном узле сгенерируем SSH-ключ для автоматической авторизации scp:
```bash
ssh-keygen -t rsa -b 4096 -C "postgres1@pg167" # на все вопросы отвечаем Enter
ssh-copy-id -i ~/.ssh/id_rsa.pub postgres0@pg175
```

Проверка: (доступ к резервному узлу без пароля)
```
[postgres1@pg167 ~]$ ssh postgres0@pg175
Last login: Sat Nov  2 12:50:24 2024 from 192.168.11.167
[postgres0@pg175 ~]$ 
```

Загружаем изменения в конфигурацию:
```bash
scp -o "ProxyJump s372819@se.ifmo.ru:2222" main_pg167/postgresql.conf postgres1@pg167:~/khk43
```

### Настройка полного резервного копирования (pg_basebackup) по расписанию

Создаем директорию для хранения резервных копий на основном узле:
```bash
mkdir -p ~/backups
```
Также в резервном узле:
```bash
mkdir -p ~/backups
```

Для разрешения подключения для репликации на основном узле добавим строку в [`pg_hba.conf`](./main_pg167/pg_hba.conf):
```conf
local   replication     all                                     peer map=my_map
```
Загрузим изменения:
```bash
scp -o "ProxyJump s372819@se.ifmo.ru:2222" main_pg167/pg_hba.conf postgres1@pg167:~/khk43
```
Перезапустим сервер:
```bash
pg_ctl -D ~/khk43 restart
```

Создаем [скрипт](./main_pg167/backup.sh) для резервного копирования `backup.sh` на основном узле:
```bash
#!/bin/bash

CURRENT_DATE=$(date "+%Y-%m-%d_%H:%M:%S")
BACKUP_DIR="~/backups/$CURRENT_DATE"
mkdir -p "$BACKUP_DIR"

# Создаем полную резервную копию
pg_basebackup -D "$BACKUP_DIR" -F tar -z -P -p 9555 # 9555 - порт указанный в основном узле postgresql.conf

# Копируем резервную копию на резервный узел
scp "$BACKUP_DIR"/*.tar.gz postgres0@pg175:~/backups/

# Удаляем резервные копии старше 7 дней на основном узле
find ~/backups/ -type d -mtime +7 -exec rm -rf {} \;

# Удаляем WAL-файлы старше 7 дней на основном узле
find ~/oka84/ -type f -mtime +7 -exec rm -f {} \; # по предыдущему заданию WAL-файлы хранятся в '~/oka84/'

# Удаляем резервные копии старше 28 дней на резервном узле
ssh postgres0@pg175 'find ~/backups/ -type d -mtime +28 -exec rm -rf {} \;'

# Удаляем WAL-файлы старше 28 дней на резервном узле
ssh postgres0@pg175 'find ~/wal_archive/ -type f -mtime +28 -exec rm -f {} \;'
```
Загружаем скрипт на основной узел:
```bash
scp -o "ProxyJump s372819@se.ifmo.ru:2222" main_pg167/backup.sh postgres1@pg167:~
```
Сделаем скрипт исполняемым:
```bash
chmod +x backup.sh
```

Добавляем задачу в cron на основном узле:
```bash
crontab -e
```
Добавляем строку (каждое воскресенье в 2 часа ночи):
```
0 2 * * 0 ~/backup.sh >> ~/backup.log 2>&1
```

Проверим работоспособность скрипта:
```bash
bash ~/backup.sh >> ~/backup.log 2>&1
```
Результаты выполнения скрипта:
```
[postgres1@pg167 ~]$ cat backup.log
ожидание контрольной точки
    2/31300 КБ (0%), табличное пространство 0/3
    2/31300 КБ (0%), табличное пространство 1/3
    4/31300 КБ (0%), табличное пространство 1/3
    4/31300 КБ (0%), табличное пространство 2/3
31314/31314 КБ (100%), табличное пространство 2/3
31314/31314 КБ (100%), табличное пространство 3/3
```

### Подсчет объема резервных копий

**Исходные данные:**

- Средний объем новых данных в БД за сутки: 800 МБ
- Средний объем измененных данных за сутки: 1000 МБ
- Частота полного резервного копирования: раз в неделю (посредством pg_basebackup).
- Архивирование WAL: непрерывное, ежедневно.
- Срок хранения копий:
    - На основном узле: 1 неделя.
    - На резервном узле: 4 недели.

**Подсчет:**

Объем данных за неделю:
- Новые данные за неделю: 800 МБ/сутки * 7 дней = 5.6 ГБ.
- Измененные данные за неделю (WAL): 1000 МБ/сутки * 7 дней = 7 ГБ.

Объем резервных копий на основном узле:

- Полные резервные копии:
    - Количество хранимых копий: 1 (поскольку срок хранения — 1 неделя).
    - Объем последней полной копии: 5.6 ГБ * 4 недели = 22.4 ГБ. (Предполагается, что каждая последующая полная копия включает накопленные данные за предыдущие недели).

- Архивы WAL:
    - Количество хранимых архивов: 1 неделя.
    - Общий объем WAL за неделю: 7 ГБ.

- Итого объем на основном узле = 22.4 ГБ (полные копии) + 7 ГБ (WAL) = 29.4 ГБ.

Объем резервных копий на резервном узле:

- Полные резервные копии:
    - Количество хранимых копий: 4 (поскольку срок хранения — 4 недели).
    - Общий объем полных копий за месяц: $S_n = \frac{n \cdot (2a_1 + (n-1)d)}{2} = \frac{4 \cdot (2 \cdot 5.6 + 3 \cdot 5.6)}{2} = 10 \cdot 5.6 = 56$ ГБ.

- Архивы WAL:
    - Количество хранимых архивов: 4 недели.
    - Общий объем WAL за месяц: 4 * 7 = 28 ГБ.

- Итого объем на резервном узле = 56 ГБ (полные копии) + 28 ГБ (WAL) = 84 ГБ.

Тем не менее из-за сжатия данных, объем резервных копий будет меньше. Поэтому можно считать что объем резервных копий не слишком велик учитывая большой объем данных в БД.


## Этап 2. Потеря основного узла