# Дополнительное задание

создать таблицу
добавить 2 строки
backup: pg_basebackup 
добавить 1 строку
time
truncate from table
recover to: time

Для этого понадобится wal по времени


# Решение

Создание таблицы

```sql
CREATE TABLE dop_table (
    id SERIAL PRIMARY KEY,
    data TEXT
);

INSERT INTO dop_table (data) VALUES ('First row'), ('Second row');
```

Создание резервной копии запуская pg_basebackup

```bash
./backup.sh
```

Добавление ещё строки

```sql
INSERT INTO dop_table (data) VALUES ('Third row');
```

Время

```sql
SELECT now();
```
Вывод:
```
postgres=# SELECT now();
              now
-------------------------------
 2024-11-05 14:17:45.472299+03
(1 строка)
```

Удаление всех строк из таблицы

```sql
TRUNCATE dop_table;
```

Остановим сервер

```bash
pg_ctl -D ~/khk43 stop
```


Восстановление к моменту времени. Добавим в `postgresql.conf`:

```conf
restore_command = 'scp postgres0@pg175:~/wal_archive/%f "%p"'
recovery_target_time = '2024-11-05 14:17:45.472299+03'
```

[`dop.sh`](./main_pg167/dop.sh)
```bash
cp khk43/pg_ident.conf pg_ident.conf
cp khk43/pg_hba.conf pg_hba.conf
cp khk43/postgresql.conf postgresql.conf
rm -rf ~/khk43/*
cd ~/backups/
BACKUP_DIR=$(ls -td */ | head -n 1) # выбираем последнюю резервную копию
cd $BACKUP_DIR
tar -xzf base.tar.gz -C ~/khk43
tar -xzf pg_wal.tar.gz -C ~/khk43/pg_wal

cp ~/pg_ident.conf ~/khk43/pg_ident.conf
cp ~/pg_hba.conf ~/khk43/pg_hba.conf
cp ~/postgresql.conf ~/khk43/postgresql.conf

touch ~/khk43/recovery.signal

pg_ctl -D ~/khk43 -l файл_журнала start
```

Подключимся к серверу и проверим таблицу

```bash
psql -p 9555 -d postgres -U postgres1
```
```sql
SELECT * FROM dop_table;
```